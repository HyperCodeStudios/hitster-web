<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hitster Web â€“ Ultimate Edition</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #121212; color: #fff; padding: 20px; }
    h1 { text-align: center; color: #1db954; }
    button { background: #1db954; border: none; color: white; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 5px; }
    button:hover { background: #1ed760; }
    .playlist-grid, .song-grid { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
    .playlist-card, .song-card { background: #181818; border-radius: 10px; padding: 15px; width: 200px; text-align: center; box-shadow: 0 0 8px #000; position: relative; }
    .year-badge { font-size: 1.6em; font-weight: bold; margin: 10px 0; display: block; transition: all 0.3s; }
    .source-badge { font-size: 0.7em; opacity: 0.7; min-height: 15px; }
    canvas { margin-top: 10px; border-radius: 4px; background: white; padding: 5px; }
    small { color: #aaa; }
  </style>
</head>
<body>
  <h1>ðŸŽ¶ Hitster Web</h1>
  <div id="app" style="text-align:center;"></div>
  
  <script>
    // --- KONFIGURATION ---
    const SPOTIFY_CLIENT_ID = "ba3eba27da4948e7bcad1872acdc48ab"; 
    
    // ðŸ”¥ DEIN DISCOGS TOKEN HIER EINTRAGEN:
    const DISCOGS_TOKEN = "HIER_DEINEN_DISCOGS_TOKEN_EINFÃœGEN"; 

    const REDIRECT_URI = "https://hypercodestudios.github.io/hitster-web/";
    const AUTH_ENDPOINT = "https://accounts.spotify.com/authorize";
    const TOKEN_ENDPOINT = "https://accounts.spotify.com/api/token";
    const API_ENDPOINT = "https://api.spotify.com/v1";

    let accessToken = localStorage.getItem("spotify_token");

    // --- HELPER: TEXT NORMALISIEREN ---
    function normalize(str) {
        if (!str) return "";
        return str.toLowerCase().replace(/[^a-z0-9 ]/g, "").trim();
    }

    // --- HELPER: TITEL BEREINIGEN ---
    function cleanTitle(title) {
        return title
            .replace(/\s*-\s*.*remaster.*/i, '')
            .replace(/\s*\(.*remaster.*\)/i, '')
            .replace(/\s*-\s*radio\s*edit.*/i, '')
            .replace(/\s*\(.*radio\s*edit.*\)/i, '')
            .replace(/\s*-\s*live.*/i, '')
            .replace(/\s*\(.*live.*\)/i, '')
            .replace(/\s*feat\..*/i, '')
            .replace(/\s*\/.*$/, '') 
            .trim();
    }

    // --- VERBESSERTER KÃœNSTLER CHECK (Regex verhindert Fehlmatch bei kurzen Namen) ---
    function isArtistMatch(spotifyArtist, discogsResultTitle) {
        const sArtist = normalize(spotifyArtist);
        const dTitle = normalize(discogsResultTitle);
        // PrÃ¼ft, ob der KÃ¼nstlername als eigenstÃ¤ndiges Wort vorkommt
        const regex = new RegExp(`\\b${sArtist}\\b`, 'i');
        return regex.test(dTitle);
    }

    // --- DISCOGS API MIT PLAUSIBILITÃ„TS-CHECK ---
    async function getDiscogsYear(artist, title, spotifyYear) {
        if (!DISCOGS_TOKEN || DISCOGS_TOKEN.includes("HIER_DEINEN")) return null;

        const clean = cleanTitle(title);
        const query = `${artist} - ${clean}`;
        const sYearInt = parseInt(spotifyYear);
        
        // Suche nach Master-Releases (Ã¤lteste zuerst)
        const url = `https://api.discogs.com/database/search?q=${encodeURIComponent(query)}&type=master&sort=year&sort_order=asc&token=${DISCOGS_TOKEN}`;

        try {
            const res = await axios.get(url);
            const items = res.data.results;

            for (let item of items) {
                if (item.year && item.year.match(/^\d{4}$/)) {
                    const dYearInt = parseInt(item.year);
                    
                    // 1. Artist Match
                    if (isArtistMatch(artist, item.title)) {
                        // 2. PlausibilitÃ¤ts-Check:
                        // Wenn Discogs mehr als 20 Jahre Ã¤lter ist als Spotify, ist es bei 
                        // modernen KÃ¼nstlern (wie Cro) ein Fehler. Ausnahme: Sehr alte Spotify-Daten.
                        if (sYearInt - dYearInt > 20 && sYearInt > 2000) {
                            console.warn(`Ãœberspringe ${item.year} fÃ¼r ${title} (Unplausibel zu Spotify ${spotifyYear})`);
                            continue; 
                        }
                        return { year: item.year, source: 'Discogs' };
                    }
                }
            }
        } catch (e) { console.error("Discogs API Error", e); }
        return null;
    }

    // --- SPOTIFY AUTH FLOW ---
    async function login() {
        const verifier = Array.from(window.crypto.getRandomValues(new Uint8Array(32)), b => ('0' + b.toString(16)).slice(-2)).join('');
        localStorage.setItem("verifier", verifier);
        const encoder = new TextEncoder();
        const data = encoder.encode(verifier);
        const digest = await window.crypto.subtle.digest('SHA-256', data);
        const challenge = btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        
        const params = new URLSearchParams({
            client_id: SPOTIFY_CLIENT_ID, response_type: "code", redirect_uri: REDIRECT_URI,
            scope: "playlist-read-private", code_challenge_method: "S256", code_challenge: challenge
        });
        window.location = `${AUTH_ENDPOINT}?${params}`;
    }

    async function handleCallback() {
        const code = new URLSearchParams(window.location.search).get("code");
        if (!code) return;
        window.history.replaceState({}, document.title, REDIRECT_URI);
        const body = new URLSearchParams({
            client_id: SPOTIFY_CLIENT_ID, grant_type: "authorization_code", code,
            redirect_uri: REDIRECT_URI, code_verifier: localStorage.getItem("verifier")
        });
        const res = await fetch(TOKEN_ENDPOINT, { method: "POST", headers: {"Content-Type":"application/x-www-form-urlencoded"}, body });
        const data = await res.json();
        if (data.access_token) localStorage.setItem("spotify_token", data.access_token);
    }

    // --- UI & LOGIK ---
    async function init() {
        if (!accessToken) await handleCallback();
        accessToken = localStorage.getItem("spotify_token");
        if (!accessToken) { app.innerHTML = `<button onclick="login()">Mit Spotify verbinden</button>`; return; }
        
        app.innerHTML = `<h2>WÃ¤hle eine Playlist</h2><div id="playlists" class="playlist-grid"></div><div id="songs" class="song-grid"></div>`;
        const { data } = await axios.get(`${API_ENDPOINT}/me/playlists`, { headers: { Authorization: "Bearer " + accessToken } });
        document.getElementById("playlists").innerHTML = data.items.map(p => `
            <div class="playlist-card">
                <img src="${p.images[0]?.url||''}" width="100%">
                <p><b>${p.name}</b></p>
                <button onclick="loadTracks('${p.id}')">Songs laden</button>
            </div>
        `).join("");
    }

    async function loadTracks(pid) {
        const box = document.getElementById("songs");
        box.innerHTML = `<p>Analysiere Jahre... Bitte warten (Discogs Rate Limit)...</p>`;
        const { data } = await axios.get(`${API_ENDPOINT}/playlists/${pid}/tracks`, { headers: { Authorization: "Bearer " + accessToken } });
        box.innerHTML = "";

        for (const item of data.items) {
            const t = item.track;
            if (!t) continue;
            const div = document.createElement("div");
            div.className = "song-card";
            const yId = `y-${t.id}`, iId = `i-${t.id}`;
            let sYear = t.album.release_date.substring(0,4);

            div.innerHTML = `
                <img src="${t.album.images[1]?.url||''}" width="80" style="border-radius:4px"><br>
                <b>${t.name}</b><br><small>${t.artists[0].name}</small><br>
                <span id="${yId}" class="year-badge" style="color:#888;">${sYear}</span>
                <div id="${iId}" class="source-badge">Spotify</div>
                <canvas id="qr-${t.id}"></canvas>
            `;
            box.appendChild(div);
            QRCode.toCanvas(document.getElementById(`qr-${t.id}`), t.external_urls.spotify, { width: 110, margin:1, color: {dark:"#1db954"} });

            // Discogs Abfrage mit 1.1s Delay (Rate Limit Protection)
            await new Promise(r => setTimeout(r, 1100));
            getDiscogsYear(t.artists[0].name, t.name, sYear).then(res => {
                const el = document.getElementById(yId), info = document.getElementById(iId);
                if (res && res.year && res.year !== sYear) {
                    el.textContent = res.year;
                    el.style.color = "#ffcc00"; 
                    info.textContent = `Korrigiert via ${res.source}`;
                    info.style.color = "#ffcc00";
                } else {
                    el.style.color = "#fff";
                    info.textContent = res ? "BestÃ¤tigt" : "Spotify Original";
                }
            });
        }
    }

    init();
  </script>
</body>
</html>
