<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Hitster Web</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    :root { --spotify-green: #1db954; --bg-black: #121212; --card-bg: #1e1e1e; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg-black); color: #fff; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
    
    header { padding: 15px; text-align: center; z-index: 10; }
    h1 { color: var(--spotify-green); margin: 0; font-size: 1.5rem; letter-spacing: 1px; }

    /* Scanner-Container: Nimmt den oberen Teil ein */
    #scanner-wrapper { position: relative; width: 100%; flex-grow: 1; display: flex; justify-content: center; align-items: center; background: #000; }
    #reader { width: 100% !important; height: 100% !important; border: none !important; }
    #reader video { object-fit: cover !important; }
    /* Versteckt die UI-Elemente der Library */
    #reader__dashboard, #reader__status_span { display: none !important; }
    
    /* Overlay für den Scan-Bereich */
    .scan-overlay { position: absolute; width: 200px; height: 200px; border: 2px solid var(--spotify-green); border-radius: 20px; box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); pointer-events: none; z-index: 5; }

    /* Unterer Bereich für Controls */
    .controls-container { background: var(--card-bg); padding: 20px; border-top-left-radius: 25px; border-top-right-radius: 25px; text-align: center; z-index: 10; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
    
    #message { margin-bottom: 15px; font-weight: 500; font-size: 1.1rem; min-height: 1.4em; }

    .playback-row { display: flex; justify-content: center; align-items: center; gap: 20px; }
    .btn-seek { background: transparent; border: 1px solid #444; color: #ccc; width: 50px; height: 50px; border-radius: 50%; font-size: 0.9rem; cursor: pointer; }
    .btn-main { background: var(--spotify-green); border: none; color: white; width: 70px; height: 70px; border-radius: 50%; font-size: 1.5rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(29, 185, 84, 0.4); }
    
    .login-box { padding: 40px; text-align: center; }
    .hidden { display: none !important; }
    
    .hint { font-size: 0.75rem; color: #777; margin-top: 15px; }
  </style>
</head>
<body>

  <header>
    <h1>HITSTER</h1>
  </header>

  <div id="login-section" class="login-box hidden">
    <p>Bitte logge dich ein, um zu scannen.</p>
    <button class="btn-main" style="width: auto; border-radius: 30px; padding: 0 30px;" onclick="login()">Spotify Login</button>
  </div>

  <div id="player-section" class="hidden" style="display: contents;">
    <div id="scanner-wrapper">
      <div id="reader"></div>
      <div class="scan-overlay"></div>
    </div>

    <div class="controls-container">
      <div id="message">Bereit zum Scannen...</div>
      
      <div class="playback-row">
        <button class="btn-seek" onclick="seek(-15000)">-15s</button>
        <button class="btn-main" id="playPauseBtn" onclick="togglePlayPause()">▶</button>
        <button class="btn-seek" onclick="seek(15000)">+15s</button>
      </div>
      
      <p class="hint">Spotify muss im Hintergrund aktiv sein.</p>
      <a href="admin.html" style="color: #444; text-decoration: none; font-size: 0.7rem; display: block; margin-top: 10px;">⚙ Editor</a>
    </div>
  </div>

  <script>
    const SPOTIFY_CLIENT_ID = "ba3eba27da4948e7bcad1872acdc48ab"; 
    const REDIRECT_URI = "https://hypercodestudios.github.io/hitster-web/";
    let accessToken = localStorage.getItem("spotify_token");
    let isPlaying = false;
    let html5QrCode;

    // --- AUTOMATISCHER SCANNER START ---
    async function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        try {
            // "environment" erzwingt die Rückkamera
            await html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                const url = new URL(decodedText);
                const id = url.searchParams.get("id");
                if (id) playTrack(id);
            });
        } catch (err) {
            document.getElementById('message').textContent = "Kamera-Fehler. Bitte Zugriff erlauben.";
        }
    }

    // --- PLAYBACK LOGIK ---
    async function playTrack(trackId) {
        try {
            await axios({
                method: 'put',
                url: 'https://api.spotify.com/v1/me/player/play',
                data: { uris: [`spotify:track:${trackId}`] },
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            document.getElementById('message').innerHTML = `<span style="color:#1db954">Lied wird abgespielt!</span>`;
            isPlaying = true;
            updateUI();
        } catch (err) {
            document.getElementById('message').innerHTML = `<span style="color:#ff5555">Spotify am Handy öffnen!</span>`;
        }
    }

    async function togglePlayPause() {
        const action = isPlaying ? 'pause' : 'play';
        try {
            await axios({
                method: 'put',
                url: `https://api.spotify.com/v1/me/player/${action}`,
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            isPlaying = !isPlaying;
            updateUI();
        } catch (e) {}
    }

    async function seek(ms) {
        try {
            const status = await axios.get('https://api.spotify.com/v1/me/player', {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const newPos = Math.max(0, status.data.progress_ms + ms);
            await axios.put(`https://api.spotify.com/v1/me/player/seek?position_ms=${newPos}`, {}, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
        } catch (e) {}
    }

    function updateUI() {
        document.getElementById('playPauseBtn').textContent = isPlaying ? "⏸" : "▶";
    }

    // --- AUTH ---
    function login() {
        const scopes = "user-modify-playback-state user-read-playback-state";
        window.location = `https://accounts.spotify.com/authorize?client_id=${SPOTIFY_CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(scopes)}`;
    }

    async function init() {
        // Check for Implicit Grant Token in URL
        const hash = window.location.hash.substring(1);
        if (hash) {
            const params = new URLSearchParams(hash);
            accessToken = params.get('access_token');
            if (accessToken) {
                localStorage.setItem("spotify_token", accessToken);
                window.history.replaceState({}, document.title, REDIRECT_URI);
            }
        }

        if (!accessToken) {
            document.getElementById('login-section').classList.remove('hidden');
        } else {
            document.getElementById('player-section').classList.remove('hidden');
            startScanner();
        }
    }

    init();
  </script>
</body>
</html>