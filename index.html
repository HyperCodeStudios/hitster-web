<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hitster Web â€“ Ultimate Edition</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #121212; color: #fff; padding: 20px; }
    h1 { text-align: center; color: #1db954; }
    button { background: #1db954; border: none; color: white; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 5px; }
    button:hover { background: #1ed760; }
    .playlist-grid, .song-grid { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
    .playlist-card, .song-card { background: #181818; border-radius: 10px; padding: 15px; width: 200px; text-align: center; box-shadow: 0 0 8px #000; position: relative; }
    .year-badge { font-size: 1.4em; font-weight: bold; margin: 10px 0; display: block; }
    .source-badge { font-size: 0.7em; opacity: 0.7; }
    canvas { margin-top: 10px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>ðŸŽ¶ Hitster Web (Discogs Powered)</h1>
  <div id="app" style="text-align:center;"></div>
  
  <script>
    // --- KONFIGURATION ---
    const SPOTIFY_CLIENT_ID = "ba3eba27da4948e7bcad1872acdc48ab"; // Deine Spotify ID
    
    const DISCOGS_TOKEN = "wqMZDlzvFFtlVOnUskoEiDMMlHlBsUFdJVBthaqZ"; 

    const REDIRECT_URI = "https://hypercodestudios.github.io/hitster-web/";
    
    // Spotify URLs (Korrekt)
    const AUTH_ENDPOINT = "https://accounts.spotify.com/authorize";
    const TOKEN_ENDPOINT = "https://accounts.spotify.com/api/token";
    const API_ENDPOINT = "https://api.spotify.com/v1";

    let accessToken = localStorage.getItem("spotify_token");

    // --- HELPER: TITEL BEREINIGEN ---
    function cleanTitle(title) {
        return title
            .replace(/\s*-\s*.*remaster.*/i, '')
            .replace(/\s*\(.*remaster.*\)/i, '')
            .replace(/\s*-\s*radio\s*edit.*/i, '')
            .replace(/\s*\(.*radio\s*edit.*\)/i, '')
            .replace(/\s*-\s*live.*/i, '')
            .replace(/\s*\(.*live.*\)/i, '')
            .replace(/\s*feat\..*/i, '')
            .replace(/\s*\/.*$/, '') // Entfernt alles nach einem Slash
            .trim();
    }

    // --- HELPER: DISCOGS API ---
    async function getDiscogsYear(artist, title) {
        if (!DISCOGS_TOKEN || DISCOGS_TOKEN === "HIER_DEINEN_DISCOGS_TOKEN_EINFÃœGEN") return null;

        const clean = cleanTitle(title);
        const query = `${artist} - ${clean}`;
        
        // Wir suchen nach "Master" Releases und sortieren nach Jahr aufsteigend
        // Das liefert meistens das absolut erste Vorkommen.
        const url = `https://api.discogs.com/database/search?q=${encodeURIComponent(query)}&type=master&sort=year&sort_order=asc&token=${DISCOGS_TOKEN}`;

        try {
            const res = await axios.get(url);
            const items = res.data.results;

            // Suche das erste gÃ¼ltige Jahr (4 Ziffern)
            const validItem = items.find(i => i.year && i.year.match(/^\d{4}$/));
            
            if (validItem) {
                return { year: validItem.year, source: 'Discogs' };
            }

            // Fallback: Wenn kein "Master" gefunden wurde, suchen wir nach normalen Releases (Singles etc.)
            const urlRelease = `https://api.discogs.com/database/search?q=${encodeURIComponent(query)}&type=release&sort=year&sort_order=asc&token=${DISCOGS_TOKEN}`;
            const resRel = await axios.get(urlRelease);
            const validRelease = resRel.data.results.find(i => i.year && i.year.match(/^\d{4}$/));
            
            if (validRelease) {
                return { year: validRelease.year, source: 'Discogs (Rel)' };
            }

        } catch (e) {
            console.warn("Discogs Error:", e);
        }
        return null;
    }

    // --- AUTH FLOW ---
    async function generateCodeVerifier(len=128) {
        const arr = new Uint8Array(len);
        window.crypto.getRandomValues(arr);
        return btoa(String.fromCharCode(...arr)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'').substring(0,len);
    }
    async function generateCodeChallenge(v) {
        const enc = new TextEncoder().encode(v);
        const digest = await window.crypto.subtle.digest('SHA-256', enc);
        return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }

    async function login() {
        const verifier = await generateCodeVerifier();
        localStorage.setItem("verifier", verifier);
        const challenge = await generateCodeChallenge(verifier);
        const params = new URLSearchParams({
            client_id: SPOTIFY_CLIENT_ID, response_type: "code", redirect_uri: REDIRECT_URI,
            scope: "playlist-read-private playlist-read-collaborative", code_challenge_method: "S256", code_challenge: challenge
        });
        window.location = `${AUTH_ENDPOINT}?${params}`;
    }

    async function handleCallback() {
        const code = new URLSearchParams(window.location.search).get("code");
        if (!code) return;
        window.history.replaceState({}, document.title, REDIRECT_URI);
        const body = new URLSearchParams({
            client_id: SPOTIFY_CLIENT_ID, grant_type: "authorization_code", code,
            redirect_uri: REDIRECT_URI, code_verifier: localStorage.getItem("verifier")
        });
        try {
            const res = await fetch(TOKEN_ENDPOINT, { method: "POST", headers: {"Content-Type":"application/x-www-form-urlencoded"}, body });
            const data = await res.json();
            if (data.access_token) {
                localStorage.setItem("spotify_token", data.access_token);
                location.reload();
            }
        } catch(e) { console.error(e); }
    }

    // --- APP LOGIC ---
    async function init() {
        if (!accessToken) { await handleCallback(); accessToken = localStorage.getItem("spotify_token"); }
        if (!accessToken) { app.innerHTML = `<button onclick="login()">Login mit Spotify</button>`; return; }
        
        app.innerHTML = `<h2>Deine Playlists</h2><div id="playlists" class="playlist-grid">Lade...</div><div id="songs" class="song-grid"></div>`;
        
        try {
            const { data } = await axios.get(`${API_ENDPOINT}/me/playlists`, { headers: { Authorization: "Bearer " + accessToken } });
            document.getElementById("playlists").innerHTML = data.items.map(p => `
                <div class="playlist-card">
                    <img src="${p.images[0]?.url||''}" width="100%">
                    <div style="margin:10px 0;"><b>${p.name}</b></div>
                    <button onclick="loadTracks('${p.id}')">Starten</button>
                </div>
            `).join("");
        } catch (e) { localStorage.removeItem("spotify_token"); app.innerHTML += "<br>Session expired."; }
    }

    async function loadTracks(pid) {
        const box = document.getElementById("songs");
        box.innerHTML = `<p>Lade Playlist...</p>`;
        
        // Hole Tracks
        const { data } = await axios.get(`${API_ENDPOINT}/playlists/${pid}/tracks`, { headers: { Authorization: "Bearer " + accessToken } });
        box.innerHTML = "";

        for (const item of data.items) {
            const t = item.track;
            if (!t) continue;
            
            const div = document.createElement("div");
            div.className = "song-card";
            const yearId = `y-${t.id}`;
            const infoId = `i-${t.id}`;
            
            // Spotify Jahr als Platzhalter
            let spotifyYear = t.album.release_date.substring(0,4);

            div.innerHTML = `
                <img src="${t.album.images[1]?.url||''}" width="80" style="border-radius:4px"><br>
                <b>${t.name}</b><br>
                <small>${t.artists[0].name}</small><br>
                <span id="${yearId}" class="year-badge" style="color:#888;">${spotifyYear}</span>
                <div id="${infoId}" class="source-badge">Spotify</div>
                <canvas id="qr-${t.id}"></canvas>
            `;
            box.appendChild(div);

            QRCode.toCanvas(document.getElementById(`qr-${t.id}`), t.external_urls.spotify, { width: 120, margin:1, color: {dark:"#1db954"} });

            // ASYNC JAHR CHECKEN (Discogs)
            // Wir machen das parallel zum UI-Rendering, aber mit Delay fÃ¼r Rate-Limits
            // Discogs erlaubt ca 60 Requests pro Minute. Wir warten 1.1 Sekunden.
            await new Promise(r => setTimeout(r, 1100)); 
            
            getDiscogsYear(t.artists[0].name, t.name).then(res => {
                const el = document.getElementById(yearId);
                const info = document.getElementById(infoId);
                
                if (res && res.year && res.year < spotifyYear) {
                    // Wenn Discogs ein Ã¤lteres Jahr findet -> BINGO
                    el.textContent = res.year;
                    el.style.color = "#ffcc00"; // Gold
                    info.textContent = `Gefunden via ${res.source}`;
                    info.style.color = "#ffcc00";
                } else if (res && res.year === spotifyYear) {
                    // BestÃ¤tigt
                    el.style.color = "#fff";
                    info.textContent = "Spotify & Discogs einig";
                } else {
                    // Nix besseres gefunden
                    info.textContent = "Nur Spotify Datum";
                }
            });
        }
    }

    init();
  </script>
</body>
</html>
