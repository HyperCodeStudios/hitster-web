<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hitster Web â€“ Spotify Edition</title>

  <!-- Bibliotheken -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

  <style>
    body { font-family: system-ui, sans-serif; margin:0; padding:20px; background:#121212; color:#fff;}
    h1, h2 { text-align:center; color:#1db954;}
    button {
      background: #1db954; border:none; color:white; padding:12px 20px; border-radius:8px;
      cursor:pointer; font-weight:bold; margin:5px; width:80%;
    }
    button:hover { background:#1ed760;}
    #menu, #print, #game { max-width:600px; margin: auto; }
    .playlist-grid, .song-grid, .cards-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(120px,1fr));
      gap:12px; justify-items:center; margin-top:20px;
    }
    .playlist-card, .song-card, .pdf-card {
      background:#181818; border-radius:10px; padding:10px; text-align:center; box-shadow:0 0 8px #000;
    }
    canvas { margin-top:5px; }
    video { width:100%; border-radius:10px; margin-top:10px; }
    @media print {
      body { background:#fff; color:#000; }
    }
  </style>
</head>
<body>
  <h1>ðŸŽ¶ Hitster Web</h1>
  <div id="menu"></div>
  <div id="print" style="display:none;"></div>
  <div id="game" style="display:none;">
    <h2>Spielmodus</h2>
    <div id="scanner" style="width:100%;"></div>
    <button onclick="backToMenu()">ZurÃ¼ck</button>
  </div>
  <div id="debug" style="display:none;"></div>

<script>
(async function(){

/* ---------------- CONFIG ---------------- */
const CLIENT_ID = "ba3eba27da4948e7bcad1872acdc48ab"; // <-- Spotify Client-ID einfÃ¼gen
const REDIRECT_URI = "https://hypercodestudios.github.io/hitster-web/";
const AUTH_ENDPOINT = "https://accounts.spotify.com/authorize";
const TOKEN_ENDPOINT = "https://accounts.spotify.com/api/token";
const SCOPES = "playlist-read-private playlist-read-collaborative";

/* ---------------- HELPERS ---------------- */
function log(msg){console.log(msg);}
function show(id){document.getElementById(id).style.display="block";}
function hide(id){document.getElementById(id).style.display="none";}
function clear(id){document.getElementById(id).innerHTML="";}

async function generateCodeVerifier(length = 128) {
  let text = ''; const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  for(let i=0;i<length;i++) text += possible.charAt(Math.floor(Math.random()*possible.length));
  return text;
}

async function generateCodeChallenge(verifier){
  const encoder = new TextEncoder();
  const data = encoder.encode(verifier);
  const digest = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

/* ---------------- PKCE FLOW ---------------- */
async function redirectToAuth(){
  const verifier = await generateCodeVerifier();
  const challenge = await generateCodeChallenge(verifier);
  localStorage.setItem("verifier", verifier);
  const params = new URLSearchParams({
    response_type:"code", client_id:CLIENT_ID, scope:SCOPES, redirect_uri:REDIRECT_URI,
    code_challenge_method:"S256", code_challenge:challenge
  });
  window.location = `${AUTH_ENDPOINT}?${params.toString()}`;
}

async function handleRedirect(){
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const verifier = localStorage.getItem("verifier");
  if(!code) return null;
  const body = new URLSearchParams({client_id:CLIENT_ID, grant_type:"authorization_code", code, redirect_uri:REDIRECT_URI, code_verifier:verifier});
  try{
    const res = await fetch(TOKEN_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
    const data = await res.json();
    if(data.access_token){ localStorage.setItem("spotify_token", data.access_token); window.history.replaceState({}, document.title, REDIRECT_URI); return data.access_token; }
    return null;
  }catch(e){console.error(e); return null;}
}

/* ---------------- APP STATE ---------------- */
let accessToken = localStorage.getItem("spotify_token") || await handleRedirect();

/* ---------------- MENU ---------------- */
function renderMenu(){
  clear("menu"); hide("print"); hide("game");
  const html = `
    <h2>Willkommen!</h2>
    <button onclick="startGame()">Spiel starten</button>
    <button onclick="printCards()">Karten ausdrucken</button>
    <button onclick="logout()">Logout</button>
  `;
  document.getElementById("menu").innerHTML = html; show("menu");
}

/* ---------------- LOGOUT ---------------- */
function logout(){localStorage.removeItem("spotify_token"); accessToken=""; renderMenu();}

/* ---------------- PLAY GAME ---------------- */
window.startGame = function(){
  hide("menu"); show("game");
  const html5QrcodeScanner = new Html5Qrcode("scanner");
  html5QrcodeScanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:250 },
    (decodedText, decodedResult) => {
      alert("Gescannter Song QR-Code: "+decodedText+"\nSpÃ¤ter kann hier Spotify Player aufgerufen werden.");
    }
  ).catch(err=>console.error(err));
}

/* ---------------- PRINT CARDS ---------------- */
window.printCards = async function(){
  hide("menu"); show("print");
  clear("print");
  const container = document.getElementById("print");
  container.innerHTML="<h2>WÃ¤hle eine Playlist</h2><div id='playlists' class='playlist-grid'>Lade...</div>";
  try{
    const res = await axios.get("https://api.spotify.com/v1/me/playlists",{headers:{Authorization:"Bearer "+accessToken}});
    const grid = document.getElementById("playlists"); grid.innerHTML="";
    res.data.items.forEach(p=>{
      const div = document.createElement("div");
      div.className="playlist-card";
      div.innerHTML=`<b>${p.name}</b><br><button onclick="generatePDF('${p.id}')">PDF generieren</button>`;
      grid.appendChild(div);
    });
  }catch(e){container.innerHTML="Fehler beim Laden der Playlists";}
}

/* ---------------- GENERATE PDF ---------------- */
window.generatePDF = async function(playlistId){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const res = await axios.get(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`,{headers:{Authorization:"Bearer "+accessToken}});
  const tracks = res.data.items.map(i=>i.track).filter(t=>t);
  let x=10,y=10,counter=0;
  for(const t of tracks){
    const canvas = document.createElement("canvas");
    await QRCode.toCanvas(canvas, t.external_urls.spotify,{width:80});
    pdf.setFontSize(10);
    pdf.rect(x,y,80,80);
    pdf.text(t.name,x+5,y+10);
    pdf.text(t.artists[0].name,x+5,y+18);
    pdf.addImage(canvas.toDataURL(),"PNG",x+5,y+25,70,70);
    counter++;
    x+=90;
    if(counter%3===0){x=10; y+=90;}
    if(counter%12===0 && counter!==0){pdf.addPage(); x=10; y=10;}
  }
  pdf.save("hitster_cards.pdf");
}

/* ---------------- BACK TO MENU ---------------- */
window.backToMenu = renderMenu;

/* ---------------- INIT ---------------- */
if(!accessToken){renderMenu();} else{renderMenu();}

})();
</script>
</body>
</html>
