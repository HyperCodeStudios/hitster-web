<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hitster Admin ‚Äì Print Edition</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #fff; padding: 20px; margin: 0; }
    header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
    h1 { color: #fff; margin: 0; }
    .btn-back { color: #888; text-decoration: none; border: 1px solid #444; padding: 5px 15px; border-radius: 4px; }
    button { background: #fff; border: none; color: #000; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 5px; }
    button:disabled { background: #444; color: #888; cursor: not-allowed; }
    
    .playlist-grid, .song-grid { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
    .playlist-card { background: #181818; border-radius: 10px; padding: 15px; width: 200px; text-align: center; border: 1px solid #333; }
    .song-card { background: #fff; color: #000; border-radius: 8px; padding: 10px; width: 180px; text-align: center; font-size: 0.9rem; }
    .year-preview { font-size: 2rem; font-weight: bold; display: block; margin: 5px 0; }
    canvas { display: none; } /* Nur f√ºr PDF Export */
    .loading-info { color: #fff; font-style: italic; margin: 20px; text-align: center; }
  </style>
</head>
<body>

  <header>
    <h1>‚öôÔ∏è Hitster Print-Editor</h1>
    <a href="index.html" class="btn-back">‚¨Ö Player</a>
  </header>

  <div id="app" style="text-align:center;">
    <button id="export-btn" style="display:none;" onclick="generatePDF()">üìÑ PDF f√ºr Doppelseitendruck exportieren</button>
    <div id="status-msg">Lade Playlists...</div>
    <div id="playlists" class="playlist-grid"></div>
    <div id="songs" class="song-grid"></div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;
    const DISCOGS_TOKEN = "wqMZDlzvFFtlVOnUskoEiDMMlHlBsUFdJVBthaqZ"; 
    const API_ENDPOINT = "https://api.spotify.com/v1";
    let accessToken = localStorage.getItem("spotify_token");
    let currentSongs = [];
    let currentPlaylistName = "Hitster_Karten";

    async function init() {
        if (!accessToken) {
            document.getElementById('status-msg').innerHTML = "Bitte logge dich auf der Startseite ein.";
            return;
        }
        try {
            const { data } = await axios.get(`${API_ENDPOINT}/me/playlists`, { headers: { Authorization: "Bearer " + accessToken } });
            document.getElementById('status-msg').innerHTML = "";
            document.getElementById("playlists").innerHTML = data.items.map(p => `
                <div class="playlist-card">
                    <p><b>${p.name}</b></p>
                    <button onclick="loadTracks('${p.id}', '${p.name.replace(/[^a-z0-9]/gi, '_')}')">Karten laden</button>
                </div>
            `).join("");
        } catch (e) { document.getElementById('status-msg').innerHTML = "Fehler beim Laden."; }
    }

    async function loadTracks(pid, name) {
        currentPlaylistName = name;
        document.getElementById("playlists").innerHTML = "";
        document.getElementById('status-msg').innerHTML = `<div class="loading-info">Analysiere Songs f√ºr Schwarz-Wei√ü Druck...</div>`;
        
        const { data } = await axios.get(`${API_ENDPOINT}/playlists/${pid}/tracks`, { headers: { Authorization: "Bearer " + accessToken } });
        currentSongs = [];
        const box = document.getElementById("songs");
        box.innerHTML = "";

        for (const item of data.items) {
            const t = item.track;
            if (!t) continue;
            
            // Jahr ermitteln (Dummy oder Discogs - hier vereinfacht f√ºr die Logik)
            let sYear = t.album.release_date.substring(0,4);
            
            const songObj = {
                id: t.id,
                name: t.name,
                artist: t.artists[0].name,
                year: sYear,
                qrCanvasId: `qr-${t.id}`
            };
            currentSongs.push(songObj);

            const div = document.createElement("div");
            div.className = "song-card";
            div.innerHTML = `
                <div style="font-size: 0.7rem; border-bottom: 1px solid #eee;">${songObj.name}</div>
                <span class="year-preview">${songObj.year}</span>
                <div style="font-weight: bold;">${songObj.artist}</div>
                <canvas id="${songObj.qrCanvasId}"></canvas>
            `;
            box.appendChild(div);

            const playerUrl = `https://hypercodestudios.github.io/hitster-web/index.html?id=${t.id}`;
            await QRCode.toCanvas(document.getElementById(songObj.qrCanvasId), playerUrl, { 
                width: 200, margin: 1, color: { dark: "#000000", light: "#ffffff" } 
            });
        }
        
        document.getElementById('status-msg').innerHTML = `<h3>${currentSongs.length} Songs geladen</h3>`;
        document.getElementById("export-btn").style.display = "inline-block";
    }

    function generatePDF() {
        const doc = new jsPDF();
        const cardWidth = 50;
        const cardHeight = 50;
        const margin = 15;
        const gap = 5;
        const cardsPerPage = 9; // 3x3 Gitter

        let songIndex = 0;

        while (songIndex < currentSongs.length) {
            let pageBatch = currentSongs.slice(songIndex, songIndex + cardsPerPage);
            
            // SEITE A: TEXT-KARTEN
            drawTextPage(doc, pageBatch, cardWidth, cardHeight, margin, gap);
            
            // SEITE B: QR-CODES (R√ºckseite)
            doc.addPage();
            drawQRPage(doc, pageBatch, cardWidth, cardHeight, margin, gap);
            
            songIndex += cardsPerPage;
            if (songIndex < currentSongs.length) doc.addPage();
        }

        doc.save(`Hitster_${currentPlaylistName}.pdf`);
    }

    function drawTextPage(doc, songs, w, h, m, g) {
        songs.forEach((song, i) => {
            let col = i % 3;
            let row = Math.floor(i / 3);
            let x = m + col * (w + g);
            let y = m + row * (h + g);

            doc.setDrawColor(0);
            doc.rect(x, y, w, h);

            // Titel (klein oben)
            doc.setFontSize(7);
            doc.setFont(undefined, 'normal');
            doc.text(doc.splitTextToSize(song.name, w - 4), x + w/2, y + 8, { align: "center" });

            // JAHR (Ganz gro√ü mittig)
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text(song.year, x + w/2, y + 28, { align: "center" });

            // Interpret (Fett unten)
            doc.setFontSize(9);
            doc.text(doc.splitTextToSize(song.artist, w - 4), x + w/2, y + 42, { align: "center" });
        });
    }

    function drawQRPage(doc, songs, w, h, m, g) {
        // Bei der R√ºckseite m√ºssen die Karten gespiegelt angeordnet sein, 
        // damit sie beim Zusammenkleben (oder Duplexdruck) auf der richtigen Karte landen.
        songs.forEach((song, i) => {
            let col = 2 - (i % 3); // Spiegelung der Spalte f√ºr Duplex
            let row = Math.floor(i / 3);
            let x = m + col * (w + g);
            let y = m + row * (h + g);

            doc.setDrawColor(0);
            doc.rect(x, y, w, h);

            const canvas = document.getElementById(song.qrCanvasId);
            const qrData = canvas.toDataURL("image/png");
            // QR Code zentral auf der R√ºckseite
            doc.addImage(qrData, 'PNG', x + 10, y + 10, 30, 30);
            
            // Kleine ID zur Kontrolle ganz unten
            doc.setFontSize(5);
            doc.text(song.year + " - " + song.artist.substring(0,10), x + w/2, y + 48, { align: "center" });
        });
    }

    init();
  </script>
</body>
</html>