<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hitster Web – Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #121212; color: #fff; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
    h1 { color: #1db954; margin: 0; }
    .btn-back { color: #888; text-decoration: none; border: 1px solid #444; padding: 5px 15px; border-radius: 4px; }
    button { background: #1db954; border: none; color: white; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 5px; }
    .playlist-grid, .song-grid { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
    .playlist-card, .song-card { background: #181818; border-radius: 10px; padding: 15px; width: 220px; text-align: center; box-shadow: 0 4px 10px #000; position: relative; }
    .year-badge { font-size: 1.6em; font-weight: bold; margin: 10px 0; display: block; color: #ffcc00; }
    canvas { margin-top: 10px; border-radius: 4px; background: white; padding: 5px; }
    small { color: #aaa; }
    .loading-info { font-style: italic; color: #ffcc00; margin: 20px; }
  </style>
</head>
<body>

  <header>
    <h1>⚙️ Karten-Editor</h1>
    <a href="index.html" class="btn-back">⬅ Zum Player</a>
  </header>

  <div id="app" style="text-align:center;">
    <p>Lade deine Spotify Playlists...</p>
  </div>
  
  <script>
    const DISCOGS_TOKEN = "wqMZDlzvFFtlVOnUskoEiDMMlHlBsUFdJVBthaqZ"; 
    const API_ENDPOINT = "https://api.spotify.com/v1";
    let accessToken = localStorage.getItem("spotify_token");

    // --- DEINE ORIGINAL-FUNKTIONEN (UNVERÄNDERT) ---
    function normalize(str) { return str ? str.toLowerCase().replace(/[^a-z0-9 ]/g, "").trim() : ""; }
    function cleanTitle(title) { return title.replace(/\s*-\s*.*remaster.*/i, '').replace(/\s*\(.*remaster.*\)/i, '').replace(/\s*-\s*radio\s*edit.*/i, '').replace(/\s*\(.*radio\s*edit.*\)/i, '').replace(/\s*-\s*live.*/i, '').replace(/\s*\(.*live.*\)/i, '').replace(/\s*feat\..*/i, '').replace(/\s*\/.*$/, '').trim(); }
    function isArtistMatch(sA, dT) { const s = normalize(sA); const d = normalize(dT); return (new RegExp(`\\b${s}\\b`, 'i')).test(d); }

    async function getDiscogsYear(artist, title, sYear) {
        if (!DISCOGS_TOKEN) return null;
        const q = `${artist} - ${cleanTitle(title)}`;
        const url = `https://api.discogs.com/database/search?q=${encodeURIComponent(q)}&type=master&sort=year&sort_order=asc&token=${DISCOGS_TOKEN}`;
        try {
            const res = await axios.get(url);
            for (let item of res.data.results) {
                if (item.year && item.year.match(/^\d{4}$/) && isArtistMatch(artist, item.title)) return { year: item.year, source: 'Discogs' };
            }
        } catch (e) { console.error(e); }
        return null;
    }

    async function init() {
        if (!accessToken) {
            document.getElementById('app').innerHTML = `<p>Bitte logge dich zuerst auf der <a href="index.html" style="color:#1db954">Startseite</a> ein!</p>`;
            return;
        }
        
        try {
            const { data } = await axios.get(`${API_ENDPOINT}/me/playlists`, { headers: { Authorization: "Bearer " + accessToken } });
            document.getElementById("app").innerHTML = `<h2>Deine Playlists</h2><div id="playlists" class="playlist-grid"></div><div id="songs" class="song-grid"></div>`;
            document.getElementById("playlists").innerHTML = data.items.map(p => `
                <div class="playlist-card">
                    <img src="${p.images[0]?.url||''}" width="100%" style="border-radius:8px">
                    <p><b>${p.name}</b></p>
                    <button onclick="loadTracks('${p.id}')">Karten generieren</button>
                </div>
            `).join("");
        } catch (e) { document.getElementById('app').innerHTML = "Fehler beim Laden. Sitzung evtl. abgelaufen."; }
    }

    async function loadTracks(pid) {
        const box = document.getElementById("songs");
        box.innerHTML = `<div class="loading-info">Analysiere Songs (Wegen Discogs-Limit ca. 1 Sekunde pro Song)...</div>`;
        const { data } = await axios.get(`${API_ENDPOINT}/playlists/${pid}/tracks`, { headers: { Authorization: "Bearer " + accessToken } });
        box.innerHTML = "";

        for (const item of data.items) {
            const t = item.track;
            if (!t) continue;
            const div = document.createElement("div");
            div.className = "song-card";
            const yId = `y-${t.id}`;
            let sYear = t.album.release_date.substring(0,4);

            div.innerHTML = `
                <img src="${t.album.images[1]?.url||''}" width="80" style="border-radius:4px"><br>
                <b>${t.name}</b><br><small>${t.artists[0].name}</small><br>
                <span id="${yId}" class="year-badge">...</span>
                <canvas id="qr-${t.id}"></canvas>
            `;
            box.appendChild(div);

            // WICHTIG: Die URL zeigt jetzt auf die index.html
            const playerUrl = `https://hypercodestudios.github.io/hitster-web/index.html?id=${t.id}`;
            QRCode.toCanvas(document.getElementById(`qr-${t.id}`), playerUrl, { width: 130, margin:1, color: {dark:"#1db954"} });

            await new Promise(r => setTimeout(r, 1100));
            getDiscogsYear(t.artists[0].name, t.name, sYear).then(res => {
                const el = document.getElementById(yId);
                el.textContent = res ? res.year : sYear;
            });
        }
    }

    init();
  </script>
</body>
</html>
