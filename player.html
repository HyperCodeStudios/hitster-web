<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hitster Player</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { 
            background: #121212; color: white; text-align: center; 
            font-family: system-ui, sans-serif; display: flex; 
            flex-direction: column; justify-content: center; height: 100vh; margin: 0; 
        }
        .btn { 
            background: #1db954; color: white; padding: 25px; border-radius: 50px; 
            font-size: 1.5rem; border: none; cursor: pointer; font-weight: bold;
            margin: 20px; box-shadow: 0 4px 15px rgba(29, 185, 84, 0.4);
        }
        .btn:disabled { background: #444; cursor: not-allowed; }
        #status-box { 
            margin: 20px; padding: 15px; border-radius: 8px; 
            background: #181818; min-height: 50px; line-height: 1.4;
        }
        .error { color: #ff5555; border: 1px solid #ff5555; padding: 10px; border-radius: 5px; }
        .success { color: #1db954; }
        .hint { font-size: 0.9em; color: #888; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>Hitster Scan</h1>
    
    <div id="status-box">
        <div id="message">Lade Song-Informationen...</div>
    </div>

    <button class="btn" id="playBtn" disabled>â–¶ Lied abspielen</button>

    <div class="hint" id="device-hint" style="display:none;">
        ðŸ’¡ Tipp: Ã–ffne Spotify auf deinem Handy und spiele kurz ein beliebiges Lied ab, damit dein GerÃ¤t erkannt wird.
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const trackId = params.get('id');
        const token = localStorage.getItem("spotify_token");
        
        const msgEl = document.getElementById('message');
        const btn = document.getElementById('playBtn');
        const hint = document.getElementById('device-hint');

        function displayError(text) {
            msgEl.innerHTML = `<div class="error"><b>Fehler:</b><br>${text}</div>`;
            hint.style.display = "block";
        }

        if (!token) {
            displayError("Du bist nicht eingeloggt. Bitte gehe zur Hauptseite zurÃ¼ck.");
        } else if (!trackId) {
            displayError("Keine Track-ID gefunden. QR-Code ungÃ¼ltig.");
        } else {
            msgEl.textContent = "Bereit zum Abspielen";
            btn.disabled = false;
        }

        btn.onclick = async () => {
            msgEl.textContent = "Verbindung zu Spotify wird aufgebaut...";
            btn.disabled = true;

            try {
                // Spotify PUT Request zum Abspielen
                await axios({
                    method: 'put',
                    url: 'https://api.spotify.com/v1/me/player/play',
                    data: { uris: [`spotify:track:${trackId}`] },
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                msgEl.innerHTML = `<span class="success">âœ¨ Musik wird abgespielt!</span>`;
                hint.style.display = "none";
            } catch (err) {
                btn.disabled = false;
                const status = err.response ? err.response.status : 0;
                const errorData = err.response ? err.response.data.error : null;

                if (status === 401) {
                    displayError("Sitzung abgelaufen. Bitte neu einloggen.");
                } else if (status === 403) {
                    displayError("Berechtigung fehlt oder kein Premium-Account. Hast du dich neu eingeloggt?");
                } else if (status === 404) {
                    displayError("Kein aktives Spotify-GerÃ¤t gefunden.");
                } else if (errorData && errorData.reason === "PREMIUM_REQUIRED") {
                    displayError("Dieses Feature erfordert Spotify Premium.");
                } else {
                    displayError(errorData ? errorData.message : "Unbekannter API-Fehler.");
                }
            }
        };
    </script>
</body>
</html>
